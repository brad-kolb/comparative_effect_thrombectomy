---
title: "Comparative effect of thrombectomy"
format: gfm
embed-resources: true
editor: visual
execute: 
  warning: false
  error: false
  cache: false
editor_options: 
  chunk_output_type: console
---

```{r load packages, data, convenience functions}
#| echo: false
library(here)
library(tidyverse)
library(stringr)

data <- read_csv(here("data", "clean_data.csv"), show_col_types = FALSE)

varying_summary <- readRDS(here("fits", "varying_summary.RDS")) 

group_summary <- readRDS(here("fits", "group_summaries.RDS"))

comma <- function(x) format(x, digits = 3, nsmall = 1, big.mark = ",", small.mark = ",")
```

## Observed data

```{r calculations}
#| echo: false

trials <- data %>% 
  nrow()
patients_total <- with(data, sum(n_c) + sum(n_t)) 
patients_control <- with(data, sum(n_c)) 
patients_treatment <- with(data, sum(n_t)) 
categories <- n_distinct(data$K)
```

There were a total of N = `r patients_total` patients enrolled in J = `r trials` trials. `r patients_control` were randomized to best medical management. `r patients_treatment` were randomized to best medical management plus mechanical thrombectomy. Each trial was categorized into one of K = `r categories` categories according to the type of stroke patients enrolled. Category 1 was large anterior circulation strokes. Category 2 was small to medium sized anterior circulation strokes treated in an early time window. Category 3 was small to medium sized anterior circulation strokes treated in a late time window. Category 4 was strokes involving the basilar artery. The primary endpoint was functional independence at 90 days (modified Rankin score of 0 to 2).

Observed frequency of outcomes for control and treatment groups are shown below, with color corresponding to stroke type and the size of the bubble to the sample size of the trial. Bubbles above the grey dashed line denote trials in which the frequency of good outcome at 90 days was greater for thrombectomy patients than for those treated with best medical management only.

![](images/scatter_plot-03.png)

### Observed effect size

The observed relative and absolute effect sizes from each of the stroke trials are shown here, with $y$ representing the observed treatment effect of thrombectomy (the odds ratio on the log scale), $\text{se}$ representing the standard error for $y$. The quantities $\text{rr}$ and $\text{arr}$ represent the observed relative and absolute risk reduction, respectively.

```{r}
#| echo: false
data <- data %>% 
  mutate(name = c("ANGEL", "RESCUE", "SELECT2", "TENSION", "TESLA",
                   "ESCAPE", "EXTEND", "MRCLEAN", "PISTE", "RESILIENT", "REVASCAT", "SWIFT", "THERAPY", "THRACE",
                   "DAWN", "DEFUSE3", "MRCLEANLATE", "POSITIVE",
                 "ATTENTION", "BAOCHE", "BASICS", "BEST")) %>% 
  relocate("name", .after = J)

data %>% 
  mutate(rd = r_t/n_t - r_c/n_c) %>% 
  mutate(rr = (r_t/n_t) / (r_c/n_c)) %>% 
  select(J, K, name, y, se, rr, rd) %>% 
print(n = Inf)
```

The pooled data by category are shown in the following table.

```{r pooled or table}
#| echo: false
data %>% 
  group_by(K) %>% 
  summarise(trials = n(),
            "sample size" = sum(n_c + n_t),
            r_c = sum(r_c),
            n_c = sum(n_c),
            r_t = sum(r_t),
            n_t = sum(n_t)) %>% 
  mutate(
    y = log(r_t / (n_t - r_t)) - log(r_c / (n_c - r_c)),
    se = sqrt(1/r_t + 1/(n_t - r_t) + 1/r_c + 1/(n_c - r_c)),
    rd = r_t/n_t - r_c/n_c,
    rr = (r_t/n_t) / (r_c/n_c),
    category = c("large", "early", "late", "basilar")
  ) %>% 
  select(category, trials, "sample size", y, se, rr, rd)
```

The overall pooled data is shown in the following table.

```{r pooled or}
#| echo: false
(
  pooled <- data %>% 
  summarise(trials = n(),
            "sample size" = sum(n_c + n_t),
            r_c = sum(r_c),
            n_c = sum(n_c),
            r_t = sum(r_t),
            n_t = sum(n_t)) %>% 
  mutate(
    y = log(r_t / (n_t - r_t)) - log(r_c / (n_c - r_c)),
    se = sqrt(1/r_t + 1/(n_t - r_t) + 1/r_c + 1/(n_c - r_c)),
    rd = r_t/n_t - r_c/n_c,
    rr = (r_t/n_t) / (r_c/n_c)
  ) %>% 
    select(trials, "sample size", y, se, rr, rd)
  )
```

## Results

```{r control group estimates}
#| echo: false
df <- group_summary %>% 
  filter(str_detect(variable, "E_y_c"), 
         !str_detect(variable, "E_y_c_new"),
         data == "all", 
         priors == "diffuse") %>% 
  select("variable", "median", "mad", "low", "high") 

median1 <- comma(df$median[1] * 100)
low1 <- comma(df$low[1] * 100)
high1 <- comma(df$high[1] * 100)

median2 <- comma(df$median[2] * 100)
low2 <- comma(df$low[2] * 100)
high2 <- comma(df$high[2] * 100)

median3 <- comma(df$median[3] * 100)
low3 <- comma(df$low[3] * 100)
high3 <- comma(df$high[3] * 100)

median4 <- comma(df$median[4] * 100)
low4 <- comma(df$low[4] * 100)
high4 <- comma(df$high[4] * 100)
```

The average chance of functional independence for a patient enrolled in the medical arm of a large core stroke trial was `r median1`% (`r low1`% - `r high1`%) compared to `r median2`% (`r low2`% - `r high2`%) for small core stroke trials, `r median3`% (`r low3`% - `r high3`%) for extended window stroke trials, and `r median4`% (`r low4` - `r high4`%) for basilar stroke trials.

```{r treatment group estimates}
#| echo: false
df <- group_summary %>% 
  filter(str_detect(variable, "E_y_t"), 
         !str_detect(variable, "E_y_t_new"),
         data == "all", 
         priors == "diffuse") %>% 
  select("variable", "median", "mad", "low", "high") 

median1 <- comma(df$median[1] * 100)
low1 <- comma(df$low[1] * 100)
high1 <- comma(df$high[1] * 100)

median2 <- comma(df$median[2] * 100)
low2 <- comma(df$low[2] * 100)
high2 <- comma(df$high[2] * 100)

median3 <- comma(df$median[3] * 100)
low3 <- comma(df$low[3] * 100)
high3 <- comma(df$high[3] * 100)

median4 <- comma(df$median[4] * 100)
low4 <- comma(df$low[4] * 100)
high4 <- comma(df$high[4] * 100)
```

The average chance of functional independence for a patient enrolled in the treatment arm of a large core stroke trial was `r median1`% (`r low1`% - `r high1`%) compared to `r median2`% (`r low2`% - `r high2`%) for small core stroke trials, `r median3`% (`r low3`% - `r high3`%) for extended window stroke trials, and `r median4`% (`r low4` - `r high4`%) for basilar stroke trials.

```{r relative effect estimates}
#| echo: false
df <- group_summary %>% 
  filter(str_detect(variable, "E_rr"), 
         data == "all", 
         priors == "diffuse") %>% 
  select("variable", "median", "mad", "low", "high") 

chances1 <- format(df$median[1] * 100 - 100, digits = 1)
median1 <- comma(df$median[1])
low1 <- comma(df$low[1])
high1 <- comma(df$high[1])

chances2 <- format(df$median[2] * 100 - 100, digits = 1)
median2 <- comma(df$median[2])
low2 <- comma(df$low[2])
high2 <- comma(df$high[2])

chances3 <- format(df$median[3] * 100 - 100, digits = 1)
median3 <- comma(df$median[3])
low3 <- comma(df$low[3])
high3 <- comma(df$high[3])

chances4 <- format(df$median[4] * 100 - 100, digits = 1)
median4 <- comma(df$median[4])
low4 <- comma(df$low[4])
high4 <- comma(df$high[4])
```

In relative terms, thrombectomy increased the chances of a favorable outcome by `r chances1`% (aRR `r median1`, 95% PI `r low1` - `r high1`) in large core stroke trials, compared to `r chances2`% in small core trials (aRR `r median2`, 95% PI `r low2` - `r high2`), `r chances3`% in late window trials (aRR `r median3`, 95% PI `r low3` - `r high3`), and `r chances4`% in basilar occlusion trials (aRR `r median4`, 95% PI `r low4` - `r high4`).

```{r absolute effect estimates}
#| echo: false
df <- group_summary %>% 
  filter(str_detect(variable, "E_rd"), 
         data == "all", 
         priors == "diffuse") %>% 
  select("variable", "median", "mad", "low", "high") 

chances1 <- format(df$median[1] * 100, digits = 1)
median1 <- comma(df$median[1] * 100)
low1 <- comma(df$low[1] * 100)
high1 <- comma(df$high[1] * 100)

chances2 <- format(df$median[2] * 100, digits = 1)
median2 <- comma(df$median[2] * 100)
low2 <- comma(df$low[2] * 100)
high2 <- comma(df$high[2] * 100)

chances3 <- format(df$median[3] * 100, digits = 1)
median3 <- comma(df$median[3] * 100)
low3 <- comma(df$low[3] * 100)
high3 <- comma(df$high[3] * 100)

chances4 <- format(df$median[4] * 100, digits = 1)
median4 <- comma(df$median[4] * 100)
low4 <- comma(df$low[4] * 100)
high4 <- comma(df$high[4] * 100)
```

In absolute terms, thrombectomy increased the chances of a favorable outcome by `r chances1`% (aRD `r median1`, 95% PI `r low1` - `r high1`) in large core stroke trials, compared to `r chances2`% in small core trials (aRD `r median2`, 95% PI `r low2` - `r high2`), `r chances3`% in late window trials (aRD `r median3`, 95% PI `r low3` - `r high3`), and `r chances4`% in basilar occlusion trials (aRD `r median4`, 95% PI `r low4` - `r high4`).

After accounting for uncertainty in all model parameters, the projected probability of a positive impact on patient-level outcomes in a new randomized trial of thrombectomy for large core stroke was XXX% (XXX% NNT 100 - 10, XXX% NNT 10 or lower).