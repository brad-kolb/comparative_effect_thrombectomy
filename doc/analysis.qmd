---
title: "Comparative effect of thrombectomy: a bayesian analysis"
format: gfm
embed-resources: true
editor: visual
execute: 
  warning: false
  error: false
  cache: false
editor_options: 
  chunk_output_type: console
---

```{r load packages, data, convenience functions}
#| echo: false
library(here)
library(tidyverse)
library(stringr)

data <- read_csv(here("data", "clean_data.csv"), show_col_types = FALSE)

varying_summary <- readRDS(here("fits", "varying_summary.RDS")) 

group_summary <- readRDS(here("fits", "gq1_summary.RDS"))

comma <- function(x) format(x, digits = 2, nsmall = 1, big.mark = ",", small.mark = ",")
```

# Abstract

## Importance

22 randomized clinical trials of mechanical thrombectomy for ischemic stroke have been performed, but the implications of the results for patients treated outside these trials are unclear.

## Objective

To use information from existing randomized trials to infer the range of plausible patient-level outcomes in a hypothetical future trial of thrombectomy for various types of stroke, and to present this information in easy to understand terms that can be readily employed in real-world clinical scenarios.

## Data sources

Pubmed was searched through May 2024.

## Study selection

All randomized trials of best medical management versus best medical management plus modern mechanical thrombectomy were included.

## Data extraction and synthesis

Data was extracted from 22 randomized trials. A varying-slopes varying-intercepts multilevel logistic regression was fit to the extracted data. Posterior predictive distributions for model parameters were used to calculate the range of plausible absolute treatment effects in a future trial, adjusted for stroke type.

## Main outcomes and measures

The main outcome was the expected absolute difference in the probability of functional independence in the treatment versus control arm of a new hypothetical trial of mechanical thrombectomy, adjusted for stroke type.

## Results

```{r abstract results}
#| echo: false

df <- group_summary %>% 
  filter(str_detect(variable, "rd_epred")) %>% 
  select("variable", "median", "mad", "low", "high") 

rd1 <- comma(df$median[1] * 100)
rd1low <- comma(df$low[1] * 100)
rd1high <- comma(df$high[1] * 100)

rd2 <- comma(df$median[2] * 100)
rd2low <- comma(df$low[2] * 100)
rd2high <- comma(df$high[2] * 100)

rd3 <- comma(df$median[3] * 100)
rd3low <- comma(df$low[3] * 100)
rd3high <- comma(df$high[3] * 100)

rd4 <- comma(df$median[4] * 100)
rd4low <- comma(df$low[4] * 100)
rd4high <- comma(df$high[4] * 100)

```

Conditional on data from 22 previous trials and the model used to analyze the data, the expected difference in the probability of functional independence between the treatment and control arms of a new hypothetical trial of mechanical thrombectomy is greatest for small strokes treated in an early time window (`r rd2`%, `r rd2low` % - `r rd2high`%), followed by small strokes treated in a late time window (`r rd3`%, `r rd3low` - `r rd3high`%), basilar strokes (`r rd4`%, `r rd4low` - `r rd4high`%), and large strokes treated in an early time window (`r rd1`%, `r rd1low` - `r rd1high`%).

## Conclusions and relevance

The absolute treatment effect of thrombectomy in a future trial is predicted to be positive with at least 95% confidence across all stroke types, but the magnitude of the predicted effect is uncertain and varies substantially according to the type of stroke being treated.

# Introduction

There are numerous meta-analyses of stroke thrombectomy, but their results are difficult to interpret for many clinicians, which may preclude effective communication of risk and uncertainty with patients and family. Here, we employ a Bayesian framework to infer the range of plausible outcomes in a hypothetical future randomized control trial of modern stroke thrombectomy, given the observed outcomes in the 22 trials to date. We show how this framework can be used to capture the strength of evidence supporting this intervention, as well as the residual uncertainty regarding individual patient outcomes.

# Methods

This meta-analysis was conducted according to the preferred reporting items for systematic reviews and meta-analysis (PRISMA) guidelines. The initial analysis plan was preregistered on the Open Science Framework. The regression model was written in the probabilistic programming language Stan and fit to data using R. Convergence and model diagnostics were assessed according to expert recommendations, and this information is fully reported in the appendix. Sensitivity checks for the priors and the likelihood were performed. Point estimates are presented using the median of the posterior predictive distribution. 95% posterior intervals (PI), the Bayesian analogue to frequentist confidence intervals, are presented using the 2.5% and 97.5% quantiles of the posterior predictive distribution. The full statistical model as well as computer code to reproduce all analyses and figures is available on-line.

# Results

## Search Results

The initial database and registry search yielded 224 studies. Following title and abstract screening, 22 were retained, with the same amount remaining after full-text review.

## Risk of Bias

We concluded that all included studies had low risk of bias.

## Study and Population Characteristics

```{r calculations}
#| echo: false

trials <- data %>% 
  nrow()
patients_total <- with(data, sum(n_c) + sum(n_t)) 
patients_control <- with(data, sum(n_c)) 
patients_treatment <- with(data, sum(n_t)) 
categories <- n_distinct(data$K)
```

The intention to treat population included `r patients_total` participants across `r trials` randomized control trials. `r patients_control` were assigned to medical management, while `r patients_treatment` were assigned to thrombectomy plus medical management. Each trial was assigned to one of `r categories` categories according to the type of stroke patients enrolled. Category 1 ("large") was anterior circulation strokes with a large core treated in an early time window. Category 2 ("small") was anterior circulation strokes with small to medium sized cores treated in an early time window. Category 3 ("late") was anterior circulation strokes with small to medium sized cores treated in an extended time window. Category 4 ("basilar") was strokes due to large vessel occlusion of the vertebobasilar artery complex. Table 1 contains further information on study design and population characteristics.

## Descriptive Results

Observed outcomes in the intention-to-treat cohors of each trial are reported below.

```{r}
#| echo: false
data <- data %>% 
  mutate(name = c("ANGEL", "RESCUE", "SELECT2", "TENSION", "TESLA",
                   "ESCAPE", "EXTEND", "MRCLEAN", "PISTE", "RESILIENT", "REVASCAT", "SWIFT", "THERAPY", "THRACE",
                   "DAWN", "DEFUSE3", "MRCLEANLATE", "POSITIVE",
                 "ATTENTION", "BAOCHE", "BASICS", "BEST")) %>% 
  relocate("name", .after = J)

data %>% 
  mutate(size = n_c + r_c) %>% 
  mutate(f_c = r_c/n_c) %>% 
  mutate(f_t = r_t/n_t) %>% 
  mutate(rd = r_t/n_t - r_c/n_c) %>% 
  mutate(nnt = 1/rd) %>% 
  mutate(rr = (r_t/n_t) / (r_c/n_c)) %>% 
  select(K, name, size, f_c, f_t, rr, rd, nnt) %>% 
print(n = Inf)
```

The overall pooled data are shown in the following table.

```{r pooled or}
#| echo: false
data %>% 
  summarise(trials = n(),
            size = sum(n_c + n_t),
            r_c = sum(r_c),
            n_c = sum(n_c),
            r_t = sum(r_t),
            n_t = sum(n_t)) %>% 
  mutate(
    f_c = r_c/n_c,
    f_t = r_t/n_t,
    y = log(r_t / (n_t - r_t)) - log(r_c / (n_c - r_c)),
    se = sqrt(1/r_t + 1/(n_t - r_t) + 1/r_c + 1/(n_c - r_c)),
    rd = f_t - f_c,
    nnt = 1/rd,
    rr = f_t/f_c) %>% 
  select(trials, size, f_c, f_t, rr, rd, nnt)
```

The pooled data by category are shown in the following table.

```{r pooled or table}
#| echo: false
data %>% 
  group_by(K) %>% 
  summarise(trials = n(),
            size = sum(n_c + n_t),
            r_c = sum(r_c),
            n_c = sum(n_c),
            r_t = sum(r_t),
            n_t = sum(n_t)) %>% 
  mutate(
    f_c = r_c/n_c,
    f_t = r_t/n_t,
    y = log(r_t / (n_t - r_t)) - log(r_c / (n_c - r_c)),
    se = sqrt(1/r_t + 1/(n_t - r_t) + 1/r_c + 1/(n_c - r_c)),
    rd = f_t - f_c,
    nnt = 1/rd,
    rr = f_t/f_c,
    category = c("large", "early", "late", "basilar")
  ) %>% 
  select(category, trials, size, f_c, f_t, rr, rd, nnt)
```

## Treatment effect estimation

```{r control group estimates}
#| echo: false
df <- group_summary %>% 
  filter(str_detect(variable, "x_epred")) %>% 
  select("variable", "median", "mad", "low", "high") 

median1 <- format(df$median[1] * 100, digits = 1)
low1 <- comma(df$low[1] * 100)
high1 <- comma(df$high[1] * 100)

median2 <- format(df$median[2] * 100, digits = 1)
low2 <- comma(df$low[2] * 100)
high2 <- comma(df$high[2] * 100)

median3 <- format(df$median[3] * 100, digits = 1)
low3 <- comma(df$low[3] * 100)
high3 <- comma(df$high[3] * 100)

median4 <- format(df$median[4] * 100, digits = 1)
low4 <- comma(df$low[4] * 100)
high4 <- comma(df$high[4] * 100)
```

The expected probabilities of functional independence for a patient enrolled in the control arm of a new stroke trial are, in descending order, `r median2`% (95% PI `r low2`% - `r high2`%) for small stroke, `r median3`% (95% PI `r low3`% - `r high3`%) for late stroke, `r median4`% (95% PI `r low4` - `r high4`%) for basilar stroke, and `r median1`% (95% PI `r low1`% - `r high1`%) for large stroke (figure 2).

```{r treatment group estimates}
#| echo: false
df <- group_summary %>% 
  filter(str_detect(variable, "rd_epred")) %>% 
  select("variable", "median", "mad", "low", "high") 

median1 <- format(df$median[1] * 100, digits = 1)
low1 <- comma(df$low[1] * 100)
high1 <- comma(df$high[1] * 100)

median2 <- format(df$median[2] * 100, digits = 1)
low2 <- comma(df$low[2] * 100)
high2 <- comma(df$high[2] * 100)

median3 <- format(df$median[3] * 100, digits = 1)
low3 <- comma(df$low[3] * 100)
high3 <- comma(df$high[3] * 100)

median4 <- format(df$median[4] * 100, digits = 1)
low4 <- comma(df$low[4] * 100)
high4 <- comma(df$high[4] * 100)
```

Thrombectomy is expected to increase the probability of a favorable outcome in a new trial by `r median2`% (95% PI `r low2`% - `r high2`%) for small stroke, `r median3`% (95% PI `r low3`% - `r high3`%) for late srokes, `r median4`% (95% PI `r low4` - `r high4`%) for basilar strokes, and `r median1`% (95% PI `r low1`% - `r high1`%) for large strokes.

## Heterogeneity estimation

```{r}
#| echo: false

group_summary <- readRDS(here("fits", "group_summaries.RDS"))
df <- group_summary %>% 
  filter(variable == "I2",
         data == "all", 
         priors == "diffuse") %>% 
  select("variable", "median", "mad", "low", "high") 
i2_med <- comma(df$median*100)
i2_low <- comma(df$low*100)
i2_high <- comma(df$high*100)
```

The Bayesian I-squared statistic, defined as the percent portion of variation in the estimated treatment effect due to between-trial heterogeneity and not sampling variation was `r i2_med`% (95% PI `r i2_low`% - `r i2_high`%). In contrast to frequentist analyses, the I-squared statistic is of less relevance in this Bayesian analysis, since the reported treatment effects themselves are derived from the posterior predictive distributions, which intrinsically incorporate the estimated between-trial heterogeneity.

# Discussion

Experts recommend that treatment effects should be communicated to a patient in a three stage process. First, the clinician should determine what outcome the patient values most. Second, the clinician should describe the best estimate of the patient's chances of achieving that outcome without the treatment. Third, the clinician should describe the best estimate of how the treatment changes the patient's chances of achieving the outcome.

Although there are numerous meta-analyses of randomized trial data from stroke thrombectomy, none have utilized this patient-centered, common language approach to analyzing the data from these trials. In this paper, we aimed to adapt the traditional statistical model underlying most meta-analyses in order to analyze the outcomes from all 22 trials of stroke thrombectomy from this patient-centered perspective.

We found that the expected probability of functional independence for a hypothetical patient enrolled in the control arm of a new thrombectomy trial — the number we would quote as the one best estimate of this idealized patient's chances of a "good outcome" without treatment — varied considerably by stroke type, ranging from just 8% for a trial of large stroke, 20% for basilar occlusion, 26% for late-window, to 30% for small stroke in early window.

The expected improvement in the probability of functional independence associated with assignment to the treatment arm of a new trial — the number we would quote as the one best estimate of the expected "treatment effect" of thrombectomy — also showed considerable variation by stroke type, once again ranging from a relatively low 9% for large stroke (number needed to treat of 11), to more than double that for small (19%, number needed to treat 6) and late window (18%, number needed 6), with basilar in the middle at 16% (number needed to treat 7).

Because we are working in a Bayesian framework, the interpretation of the 95% intervals associated with each of these estimates is straightforward — in a new trial of thrombectomy, the actual effect size has a 95% probability of being within the stated interval. Since all of the intervals exclude zero or negative numbers, we can say that the expected effect of thrombectomy in a new trial is "statistically significant," in the sense of excluding no or negative effects with at least 97.5% probability. In fact, for each stroke type, the predicted effect of thrombectomy in a new trial is positive with 99% probability regardless of stroke type (figure 3).

But statistical significance, even from the simplified Bayesian perspective, is not important to patients and families, since what they really care about is not necessarily whether a treatment works at all — essentially, what statistical significance is supposed to tell us — but rather in how well the treatment works — how it will change their overall prognosis. This is where our Bayesian framework shines, because it also allows us to reason rigorously but in clear terms about the clinical significance of our treatment effect estimates.

To see how, compare the information content of figure 3, which focuses on a binary partition of the distribution of predicted effects into "positive" and "negative" effects, together with their associated probabilities, with the content of figure 4, which instead partitions the distributions of predicted effects into intervals corresponding to clinically significant thresholds, and displays the probability that the predicted effect in a new trial falls between each clinically significant interval. We can see that the effect estimates, which from the binary perspective of statistical significance appeared basically identical, in fact are quite different.

```{r}
#| echo: false

gq1 <- readRDS(here("fits", "gq1.RDS"))

# cumulative prob
df <- gq1$draws("rd_epred[1]") 
df1_100 <- format(length(df[df >=.01])/length(df)*100, digits = 2)
df1_20 <- format(length(df[df >= .05])/length(df)*100, digits = 2)
df1_10 <- format(length(df[df >= .1])/length(df)*100, digits = 2)
df1_5 <- format(length(df[df >= .2])/length(df)*100, digits = 2)

df <- gq1$draws("rd_epred[2]") 
df2_100 <- format(length(df[df >=.01])/length(df)*100, digits = 2)
df2_20 <- format(length(df[df >= .05])/length(df)*100, digits = 2)
df2_10 <- format(length(df[df >= .1])/length(df)*100, digits = 2)
df2_5 <- format(length(df[df >= .2])/length(df)*100, digits = 2)

df <- gq1$draws("rd_epred[3]") 
df3_100 <- format(length(df[df >=.01])/length(df)*100, digits = 2)
df3_20 <- format(length(df[df >= .05])/length(df)*100, digits = 2)
df3_10 <- format(length(df[df >= .1])/length(df)*100, digits = 2)
df3_5 <- format(length(df[df >= .2])/length(df)*100, digits = 2)

df <- gq1$draws("rd_epred[4]") 
df4_100 <- format(length(df[df >=.01])/length(df)*100, digits = 2)
df4_20 <- format(length(df[df >= .05])/length(df)*100, digits = 2)
df4_10 <- format(length(df[df >= .1])/length(df)*100, digits = 2)
df4_5 <- format(length(df[df >= .2])/length(df)*100, digits = 2)

# interval prob
df <- gq1$draws("rd_epred[1]") 
df1_100 <- format(length(df[df <.01])/length(df)*100, digits = 1)
df1_100_10 <- format(length(df[df >= .01 & df < .1])/length(df)*100, digits = 2)
df1_10_5 <- format(length(df[df >= .1 & df < .2])/length(df)*100, digits = 2)
df1_5 <- format(length(df[df >= .2])/length(df)*100, digits = 2)

df <- gq1$draws("rd_epred[2]") 
df2_100 <- format(length(df[df <.01])/length(df)*100, digits = 1)
df2_100_10 <- format(length(df[df >= .01 & df < .1])/length(df)*100, digits = 2)
df2_10_5 <- format(length(df[df >= .1 & df < .2])/length(df)*100, digits = 2)
df2_5 <- format(length(df[df >= .2])/length(df)*100, digits = 2)

df <- gq1$draws("rd_epred[3]") 
df3_100 <- format(length(df[df <.01])/length(df)*100, digits = 1)
df3_100_10 <- format(length(df[df >= .01 & df < .1])/length(df)*100, digits = 2)
df3_10_5 <- format(length(df[df >= .1 & df < .2])/length(df)*100, digits = 2)
df3_5 <- format(length(df[df >= .2])/length(df)*100, digits = 2)

df <- gq1$draws("rd_epred[4]") 
df4_100 <- format(length(df[df <.01])/length(df)*100, digits = 1)
df4_100_10 <- format(length(df[df >= .01 & df < .1])/length(df)*100, digits = 2)
df4_10_5 <- format(length(df[df >= .1 & df < .2])/length(df)*100, digits = 2)
df4_5 <- format(length(df[df >= .2])/length(df)*100, digits = 2)
```

For instance, a very permissive clinician might consider an absolute effect greater than 1% — corresponding to a number needed to treat of less than 100 — as clinically significant. From this perspective, the probability of a clinically insignificant effect in a new trial is about equal across all stroke types, `r df1_100`% for large, compared to `r df2_100`% for small core, `r df3_100`% with late window, and `r df4_100`% with basilar occlusion.

On the other hand, a more hardline clinician might have a more severe threshold for clinical significance, such as an absolute effect of greater than 20%, corresponding to a number needed to treat of less than 5. In this scenario, as shown in figure 3, our results diverge dramatically, with small strokes treated in the early or late windows having comparatively high probability of clinical significance (`r df2_5`% and `r df3_5`% respectively), in comparison to large strokes, in which the probability of a clinical significance is just `r df1_5`%.

We conclude that while thrombectomy is expected to have a positive effect on the probability of functional independence in a new trial, the size of the effect is uncertain and varies considerably by stroke type, with thrombectomy for large core stroke expected to perform substantially worse than other types in a new trial. Perhaps more importantly, the absolute probability of functional independence with or without treatment is still low, and, in the case of large stroke, exceedingly low.

# Limitations

Although we focus on predicting the expected treatment effect in a new trial of thrombectomy, it is well known that real world clinical scenarios rarely mirror those seen in clinical trials, both from the standpoint that real-world patients rarerly match patients treated in trials, and from that the standpoint that real-world care, both before, during, and after hospitalization, rarely matches what occurs in trials. For patients that do not closely match the enrollment criteria for clinical trials, or for clinicians treating patients in clinical contexts substantially different from what was seen in clinical trials, the estimates presented here should be used a starting point, describing what an idealized patient in an idealized scenario can expect. This can then serve as a useful jumping off point for a discussion of the specific ways in which the patient or the clinical context diverge from these ideals.

That being said, we have found in our own practice that some care scenarios may closely mimic exact trial conditions. For example, as an enrolling center for both DAWN and Select 2 trial, we sometimes treat patients that would have met enrollment criteria for these trials. In this case, we find that the treatment effect estimates reported above may in fact overestimate our uncertainty for how these patient will do at our hospital. In cases like these, it can make more sense to use our models per-trial treatment effect estimates, which, instead of reporting the estimated treatment effect in a hypothetical new trial, describe the estimated treatment effect in a replication of each specific trial.

Although we focus on the patient-centered perspective, we leave unadressed the possible risks associated with the treatment.

Finally, like all statistical models, our conclusions depend on the assumptions underlying the model itself. As in the case of all Bayesian models, this includes assumptions about prior distributions for each of the models parameters. In the supplementary appendix, we show that the key model estimates reported here are not sensitive to a range of prior distributions, and we also use so-called prior predictive checks to demonstrate the implications of the priors used in the analysis.

# Conclusions

In this paper, we aimed to show how an extension of the traditional meta-analytic framework using techniques from Bayesian data analysis can be used to derive rigorous yet easily interpretable conclusions about what the current landscape of stroke thrombectomy trials imply for real-world patient care scenarios. Under this analysis, thrombectomy is expected to have a positive effect on the probability of functional independence in a new trial, but the clinical impact of this effect varies by stroke type, and the absolute probability of functional independence is still low, especially for large core stroke.

# Key Points

## Question

What is the effect of thrombectomy on functional independence when considered not from the perspective of the average effect across existing trials (the typical measure in most meta-analyses) but instead from the perspective of the expected effect in a hypothetical new trial (a measure more useful for communicating risk and uncertainty to patients and fellow clinicians).

## Findings

In a new hypothetical trial, thrombectomy is expected to improve the chances of functional independence by 9% for large strokes, 16% for basilar strokes, 18% for small strokes treated in the extended time window, and 19% for small strokes treated in an early time window. These effects are all statistically significant, in the sense that their 95% prediction intervals exclude zero, but clinically uncertain, in the sense that the intervals contain values ranging from negligble to substantial effects, especially for large core stroke.

## Meaning

Evidence from 22 randomized trials implies a positive predicted effect with a clinically uncertain magnitude for individual patients treated outside of these trials, regardless of stroke type.
