---
title: "Comparative effect of thrombectomy"
format: gfm
embed-resources: true
editor: visual
execute: 
  warning: false
  error: false
  cache: false
editor_options: 
  chunk_output_type: console
---

```{r load packages, data, convenience functions}
#| echo: false
library(here)
library(tidyverse)
library(stringr)

data <- read_csv(here("data", "clean_data.csv"), show_col_types = FALSE)

varying_summary <- readRDS(here("fits", "varying_summary.RDS")) 

comma <- function(x) format(x, digits = 3, big.mark = ",", small.mark = ",")
```

## Observed Data

```{r calculations}
#| echo: false

trials <- data %>% 
  nrow()
patients_total <- with(data, sum(n_c) + sum(n_t)) %>% 
  comma()
patients_control <- with(data, sum(n_c)) %>%
  comma()
patients_treatment <- with(data, sum(n_t)) %>% 
  comma()
categories <- n_distinct(data$K)
```

There were a total of N = `r patients_total` patients enrolled in J = `r trials` trials. `r patients_control` were randomized to best medical management. `r patients_treatment` were randomized to best medical management plus mechanical thrombectomy. Each trial was categorized into one of K = `r categories` categories according to the type of stroke patients enrolled. Category 1 was large anterior circulation strokes. Category 2 was small to medium sized anterior circulation strokes treated in an early time window. Category 3 was small to medium sized anterior circulation strokes treated in a late time window. Category 4 was strokes involving the basilar artery. The primary endpoint was functional independence at 90 days (modified Rankin score of 0 to 2).

Results from the large stroke trials are shown here, with $y$ representing the observed treatment effect of thrombectomy (the odds ratio on the log scale) and $\text{se}$ representing the standard error for $y$.

```{r}
#| echo: false
data <- data %>% 
  mutate(name = c("ANGEL", "RESCUE", "SELECT2", "TENSION", "TESLA",
                   "ESCAPE", "EXTEND", "MRCLEAN", "PISTE", "RESILIENT", "REVASCAT", "SWIFT", "THERAPY", "THRACE",
                   "DAWN", "DEFUSE3", "MRCLEANLATE", "POSITIVE",
                   "ATTENTION", "BAOCHE", "BASICS", "BEST")) %>% 
  relocate("name", .after = J)

data %>% filter(K == 1)
```

Results from the early stroke trials are shown here.

```{r}
#| echo: false
data %>% filter(K == 2)
```

Results of the late stroke trials are shown here.

```{r}
#| echo: false
data %>% filter(K == 3)
```

Basilar stroke trial results are shown here.

```{r}
#| echo: false
data %>% filter(K == 4)
```

The pooled data by category are shown in the following table.

```{r pooled or table}
#| echo: false
data %>% 
  group_by(K) %>% 
  summarise(trials = n(),
            "sample size" = sum(n_c + n_t),
            r_c = sum(r_c),
            n_c = sum(n_c),
            r_t = sum(r_t),
            n_t = sum(n_t)) %>% 
  mutate(
    y = log(r_t / (n_t - r_t)) - log(r_c / (n_c - r_c)),
    se = sqrt(1/r_t + 1/(n_t - r_t) + 1/r_c + 1/(n_c - r_c)),
    category = c("large", "early", "late", "basilar")
  ) %>% 
  select(category, trials, "sample size", y, se )
```

The overall pooled data is shown in the following table.

```{r pooled or}
#| echo: false
(
  pooled <- data %>% 
  summarise(trials = n(),
            "sample size" = sum(n_c + n_t),
            r_c = sum(r_c),
            n_c = sum(n_c),
            r_t = sum(r_t),
            n_t = sum(n_t)) %>% 
  mutate(
    y = 
      log(r_t / (n_t - r_t)) - log(r_c / (n_c - r_c)),
    se = 
      sqrt(1/r_t + 1/(n_t - r_t) + 1/r_c + 1/(n_c - r_c))
  ) %>% 
    select(trials, "sample size", y, se )
  )
```

## Estimated average treatment effect of thrombectomy across trials

\![posterior densisty](plots/density_posterior.png)

```{r}
#| echo: false
df <- varying_summary %>% 
 filter(model == "varying",
         data == "early",
         priors == "diffuse",
         variable == "mu") %>% 
  select("median", "mad", "low", "high", "prob_pos")
```

For early stroke, the plotted values correspond to an estimated `r comma((exp(df$median) - 1)*100)`% average improvement in the odds of functional independence at 90 days with thrombectomy (95% CI `r comma((exp(df$low) - 1)*100)`% to `r comma((exp(df$high) - 1)*100)`%, P(+) = `r comma(df$prob_pos*100)`%).

```{r}
#| echo: false
df <- varying_summary %>% 
  filter(model == "varying",
         data == "large",
         priors == "diffuse",
         variable == "mu") %>% 
  select("median", "mad", "low", "high", "prob_pos")
```

For large stroke, the plotted values correspond to an estimated `r comma((exp(df$median) - 1)*100)`% average improvement in the odds of functional independence at 90 days with thrombectomy (95% CI `r comma((exp(df$low) - 1)*100)`% to `r comma((exp(df$high) - 1)*100)`%, P(+) = `r comma(df$prob_pos*100)`%).

```{r}
#| echo: false
df <- varying_summary %>% 
  filter(model == "varying",
         data == "late",
         priors == "diffuse",
         variable == "mu") %>% 
  select("median", "mad", "low", "high", "prob_pos")
```

For late stroke, the plotted values correspond to an estimated `r comma((exp(df$median) - 1)*100)`% average improvement in the odds of functional independence at 90 days with thrombectomy (95% CI `r comma((exp(df$low) - 1)*100)`% to `r comma((exp(df$high) - 1)*100)`%, P(+) = `r comma(df$prob_pos*100)`%).

```{r}
#| echo: false
df <- varying_summary %>% 
  filter(model == "varying",
         data == "basilar",
         priors == "diffuse",
         variable == "mu") %>% 
  select("median", "mad", "low", "high", "prob_pos")
```

For basilar stroke, the plotted values correspond to an estimated `r comma((exp(df$median) - 1)*100)`% average improvement in the odds of functional independence at 90 days with thrombectomy (95% CI `r comma((exp(df$low) - 1)*100)`% to `r comma((exp(df$high) - 1)*100)`%, P(+) = `r comma(df$prob_pos*100)`%).

## Probability the estimated average treatment effect of thrombectomy across trials exceeds certain values

The probability that the estimated average treatment effect of thrombectomy across trials is positive is shown in the following table.

```{r}
#| echo: false
(df <- varying_summary %>% 
  filter(model == "varying",
          data %in% c("early", "large", "late", "basilar"),
          priors == "diffuse",
          variable == "mu") %>% 
  select("data", "prob_pos"))
```

For each effect size greater than the zero, the probability that the estimated average treatment effect exceeds that value is shown in the following plot.

\![posterior ccdf](plots/ccdf_posterior.png)

## Anticipated relative treatment effect of thrombectomy in a new trial

\![posterior predictive density](plots/density_predictive.png)

```{r}
#| echo: false
df <- varying_summary %>% 
  filter(model == "varying",
         data == "early",
         priors == "diffuse",
         variable == "theta_new") %>% 
  select("data", "median", "mad", "low", "high", "prob_pos")
```

Translated from the log scale, the anticipated treatment effect of thrombectomy in a new early stroke trial has an odds ratio of `r comma(exp(df$median))` (95% CI `r comma(exp(df$low))` to `r comma(exp(df$high))`, P(+) = `r comma(df$prob_pos*100)`%).

```{r}
#| echo: false
df <- varying_summary %>% 
  filter(model == "varying",
         data == "large",
         priors == "diffuse",
         variable == "theta_new") %>% 
  select("data", "median", "mad", "low", "high", "prob_pos")
```

Translated from the log scale, the anticipated treatment effect of thrombectomy in a new large stroke trial has an odds ratio of `r comma(exp(df$median))` (95% CI `r comma(exp(df$low))` to `r comma(exp(df$high))`, P(+) = `r comma(df$prob_pos*100)`%).

```{r}
#| echo: false
df <- varying_summary %>% 
  filter(model == "varying",
         data == "late",
         priors == "diffuse",
         variable == "theta_new") %>% 
  select("data", "median", "mad", "low", "high", "prob_pos")
```

Translated from the log scale, the anticipated treatment effect of thrombectomy in a new late stroke trial has an odds ratio of `r comma(exp(df$median))` (95% CI `r comma(exp(df$low))` to `r comma(exp(df$high))`, P(+) = `r comma(df$prob_pos*100)`%).

```{r}
#| echo: false
df <- varying_summary %>% 
  filter(model == "varying",
         data == "basilar",
         priors == "diffuse",
         variable == "theta_new") %>% 
  select("data", "median", "mad", "low", "high", "prob_pos")
```

Translated from the log scale, the anticipated treatment effect of thrombectomy in a new basilar stroke trial has an odds ratio of `r comma(exp(df$median))` (95% CI `r comma(exp(df$low))` to `r comma(exp(df$high))`, P(+) = `r comma(df$prob_pos*100)`%).

The probability that the anticipated treatment effect of thrombectomy in a new trial for each stroke type is positive is shown in the following table.

```{r}
#| echo: false
(df <- varying_summary %>% 
  filter(model == "varying",
          data %in% c("early", "large", "late", "basilar"),
          priors == "diffuse",
          variable == "theta_new") %>% 
  select("data", "prob_pos"))
```

For each effect size greater than the zero, the probability that the anticipated treatment effect in a new trial exceeds that value is shown in the following plot.

\![ccdf predictive](plots/ccdf_predictive.png)
