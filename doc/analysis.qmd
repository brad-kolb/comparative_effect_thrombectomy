---
title: "Comparative effect of thrombectomy"
format: gfm
embed-resources: true
editor: visual
execute: 
  warning: false
  error: false
  cache: false
editor_options: 
  chunk_output_type: console
---

```{r load packages, data, convenience functions}
#| echo: false
library(here)
library(tidyverse)
library(stringr)

data <- read_csv(here("data", "clean_data.csv"), show_col_types = FALSE)

varying_summary <- readRDS(here("fits", "varying_summary.RDS")) 

group_summary <- readRDS(here("fits", "gq1_summary.RDS"))

comma <- function(x) format(x, digits = 2, nsmall = 1, big.mark = ",", small.mark = ",")
```

# Abstract

## Importance

22 randomized clinical trials of mechanical thrombectomy for ischemic stroke have been performed, but the implications of the results for patients treated outside these trials remain unclear.

## Objective

To use information from existing randomized trials to infer the range of plausible patient-level outcomes in a hypothetical future trial of thrombectomy for various types of stroke, and to present this information in easy to understand terms that can be readily employed in real-world clinical scenarios.

## Data sources

Pubmed was searched through May 2024.

## Study selection

All randomized trials of best medical management versus best medical management plus modern mechanical thrombectomy were included.

## Data extraction and synthesis

Data was extracted from 22 randomized trials (5 examining outcomes for large core stroke patients, 9 for small core stroke, 4 for late window stroke, and 4 for basilar stroke). A varying-slopes varying-intercepts multilevel logistic regression was fit to the extracted data. Posterior predictive distributions for model parameters were used to calculate the range of plausible absolute treatment effects in a future trial.

## Main outcomes and measures

The main estimand was the expected absolute difference in the probability of functional independence in the treatment versus control arm of a new hypothetical trial of mechanical thrombectomy, adjusted for stroke type. Simulation-based methods were used to calculate number needed to treat (NNT) thresholds in this hypothetical trial.

## Results

```{r abstract results}
#| echo: false

df <- group_summary %>% 
  filter(str_detect(variable, "rd_epred")) %>% 
  select("variable", "median", "mad", "low", "high") 

rd1 <- comma(df$median[1] * 100)
rd1low <- comma(df$low[1] * 100)
rd1high <- comma(df$high[1] * 100)

rd2 <- comma(df$median[2] * 100)
rd2low <- comma(df$low[2] * 100)
rd2high <- comma(df$high[2] * 100)

rd3 <- comma(df$median[3] * 100)
rd3low <- comma(df$low[3] * 100)
rd3high <- comma(df$high[3] * 100)

rd4 <- comma(df$median[4] * 100)
rd4low <- comma(df$low[4] * 100)
rd4high <- comma(df$high[4] * 100)

```

Conditional on data from 22 previous trials and the model used to analyze the data, the expected difference in the probability of functional independence between the treatment and control arms of a new hypothetical trial of mechanical thrombectomy is greatest for small strokes treated early (`r rd2`%, `r rd2low` % - `r rd2high`%), followed by small strokes treated late (`r rd3`%, `r rd3low` - `r rd3high`%), basilar strokes (`r rd4`%, `r rd4low` - `r rd4high`%), and large strokes (`r rd1`%, `r rd1low` - `r rd1high`%).

## Conclusions and relevance

The absolute treatment effect of thrombectomy in a future trial is predicted to be positive with at least 95% confidence across all stroke types, but the magnitude of this predicted effect is uncertain and varies substantially according to the type of stroke being treated.

# Introduction

There are numerous meta-analyses of stroke thrombectomy, but their results are difficult to interpret for many clinicians, which may preclude effective communication of risk and uncertainty with patients and family. Here, we employ a Bayesian framework to infer the range of plausible outcomes in a hypothetical future randomized control trial of modern stroke thrombectomy, given the observed outcomes in the 22 trials to date. We show how this framework can be used to capture the strength of evidence supporting this intervention, as well as the residual uncertainty regarding individual patient outcomes.

# Methods

This meta-analysis was conducted according to the preferred reporting items for systematic reviews and meta-analysis (PRISMA) guidelines. The initial analysis plan was preregistered on the open science framework. The regression model was written in the probabilistic programming language Stan and fit in R using cmdstanr. Posterior draws were processed using Posterior. Figures were produced in base R. Convergence and model diagnostics were assessed according to expert recommendations, and this information is fully reported in the appendix. Point estimates are presented using the median of the posterior predictive distribution. 95% posterior intervals (PI), the Bayesian analogue to frequentist confidence intervals, are presented using the 2.5% and 97.5% quantiles of the posterior distribution. The full statistical model as well as computer code to reproduce all analyses and figures is available at github.

# Results

## Search Results

The initial database and registry search yielded XXX studies. Following title and abstract screening, XXX were retained, with 22 remaining after full-text review.

## Risk of Bias

We concluded that all included studies had low risk of bias.

## Study and Population Characteristics

```{r calculations}
#| echo: false

trials <- data %>% 
  nrow()
patients_total <- with(data, sum(n_c) + sum(n_t)) 
patients_control <- with(data, sum(n_c)) 
patients_treatment <- with(data, sum(n_t)) 
categories <- n_distinct(data$K)
```

The intention to treat population included `r patients_total` participants across `r trials` randomized control trials. `r patients_control` were assigned to medical management, while `r patients_treatment` were assigned to thrombectomy plus medical management. Each trial was assigned to one of K = `r categories` categories according to the type of stroke patients enrolled. Category 1 ("large") was anterior circulation strokes with a large core treated in an early time window. Category 2 ("small") was anterior circulation strokes with small to medium sized cores treated in an early time window. Category 3 ("late") was anterior circulation strokes with small to medium sized cores treated in an extended time window. Category 4 ("basilar") was strokes due to large vessel occlusion of the vertebobasilar artery complex. Table 1 contains further information on study design and population characteristics.

## Descriptive Results

The observed fraction of patients achieving functional independence at 90 days in the control and treatment groups of each trial are shown below. The observed relative risk ratio (rr, frequency in treatment arm divided by frequency in control group), absolute risk difference (rd, frequency in treatment arm minus frequency in control group), and number needed to treat (NNT, 1/rd) are also reported.

```{r}
#| echo: false
data <- data %>% 
  mutate(name = c("ANGEL", "RESCUE", "SELECT2", "TENSION", "TESLA",
                   "ESCAPE", "EXTEND", "MRCLEAN", "PISTE", "RESILIENT", "REVASCAT", "SWIFT", "THERAPY", "THRACE",
                   "DAWN", "DEFUSE3", "MRCLEANLATE", "POSITIVE",
                 "ATTENTION", "BAOCHE", "BASICS", "BEST")) %>% 
  relocate("name", .after = J)

data %>% 
  mutate(size = n_c + r_c) %>% 
  mutate(f_c = r_c/n_c) %>% 
  mutate(f_t = r_t/n_t) %>% 
  mutate(rd = r_t/n_t - r_c/n_c) %>% 
  mutate(nnt = 1/rd) %>% 
  mutate(rr = (r_t/n_t) / (r_c/n_c)) %>% 
  select(K, name, size, f_c, f_t, rr, rd, nnt) %>% 
print(n = Inf)
```

The overall pooled data are shown in the following table.

```{r pooled or}
#| echo: false
data %>% 
  summarise(trials = n(),
            size = sum(n_c + n_t),
            r_c = sum(r_c),
            n_c = sum(n_c),
            r_t = sum(r_t),
            n_t = sum(n_t)) %>% 
  mutate(
    f_c = r_c/n_c,
    f_t = r_t/n_t,
    y = log(r_t / (n_t - r_t)) - log(r_c / (n_c - r_c)),
    se = sqrt(1/r_t + 1/(n_t - r_t) + 1/r_c + 1/(n_c - r_c)),
    rd = r_t/n_t - r_c/n_c,
    nnt = 1/rd,
    rr = (r_t/n_t) / (r_c/n_c)) %>% 
  select(trials, size, f_c, f_t, rr, rd, nnt)
```

The pooled data by category are shown in the following table.

```{r pooled or table}
#| echo: false
data %>% 
  group_by(K) %>% 
  summarise(trials = n(),
            size = sum(n_c + n_t),
            r_c = sum(r_c),
            n_c = sum(n_c),
            r_t = sum(r_t),
            n_t = sum(n_t)) %>% 
  mutate(
    f_c = r_c/n_c,
    f_t = r_t/n_t,
    y = log(r_t / (n_t - r_t)) - log(r_c / (n_c - r_c)),
    se = sqrt(1/r_t + 1/(n_t - r_t) + 1/r_c + 1/(n_c - r_c)),
    rd = r_t/n_t - r_c/n_c,
    nnt = 1/rd,
    rr = (r_t/n_t) / (r_c/n_c),
    category = c("large", "early", "late", "basilar")
  ) %>% 
  select(category, trials, size, f_c, f_t, rr, rd, nnt)
```

## Treatment effect estimation

```{r control group estimates}
#| echo: false
df <- group_summary %>% 
  filter(str_detect(variable, "x_epred")) %>% 
  select("variable", "median", "mad", "low", "high") 

median1 <- format(df$median[1] * 100, digits = 1)
low1 <- comma(df$low[1] * 100)
high1 <- comma(df$high[1] * 100)

median2 <- format(df$median[2] * 100, digits = 1)
low2 <- comma(df$low[2] * 100)
high2 <- comma(df$high[2] * 100)

median3 <- format(df$median[3] * 100, digits = 1)
low3 <- comma(df$low[3] * 100)
high3 <- comma(df$high[3] * 100)

median4 <- format(df$median[4] * 100, digits = 1)
low4 <- comma(df$low[4] * 100)
high4 <- comma(df$high[4] * 100)
```

The expected probability of functional independene for a patient enrolled in a new large core stroke trial is `r median1`% (95% PI `r low1`% - `r high1`%) compared to `r median2`% (95% PI `r low2`% - `r high2`%) for a new small core stroke trial, `r median3`% (95% PI `r low3`% - `r high3`%) for a new late window trial, and `r median4`% (95% PI `r low4` - `r high4`%) for a new basilar thrombectomy trial.

```{r treatment group estimates}
#| echo: false
df <- group_summary %>% 
  filter(str_detect(variable, "rd_epred")) %>% 
  select("variable", "median", "mad", "low", "high") 

median1 <- format(df$median[1] * 100, digits = 1)
low1 <- comma(df$low[1] * 100)
high1 <- comma(df$high[1] * 100)

median2 <- format(df$median[2] * 100, digits = 1)
low2 <- comma(df$low[2] * 100)
high2 <- comma(df$high[2] * 100)

median3 <- format(df$median[3] * 100, digits = 1)
low3 <- comma(df$low[3] * 100)
high3 <- comma(df$high[3] * 100)

median4 <- format(df$median[4] * 100, digits = 1)
low4 <- comma(df$low[4] * 100)
high4 <- comma(df$high[4] * 100)
```

In absolute terms, thrombectomy is expected to increase the probability of a favorable outcome in a new trial by `r median1`% (95% PI `r low1`% - `r high1`%) for large core, compared to `r median2`% (95% PI `r low2`% - `r high2`%) for small, `r median3`% (95% PI `r low3`% - `r high3`%) for late window trials, and `r median4`% (95% PI `r low4` - `r high4`%) for basilar trials.

## Heterogeneity estimation

```{r}
#| echo: false

group_summary <- readRDS(here("fits", "group_summaries.RDS"))
df <- group_summary %>% 
  filter(variable == "I2",
         data == "all", 
         priors == "diffuse") %>% 
  select("variable", "median", "mad", "low", "high") 
i2_med <- comma(df$median*100)
i2_low <- comma(df$low*100)
i2_high <- comma(df$high*100)
```

In this meta-analysis, the median estimate of the Bayesian I-squared statistic, defined as the percent portion of variation in the estimated treatment effect due to between-trial heterogeneity and not sampling variation was `r i2_med`% (95% PI `r i2_low`% - `r i2_high`%). In contrast to frequentist analyses, the I-squared statistic is of less relevance in this Bayesian analysis, since the reported treatment effects themselves are derived from the posterior predictive distributions, which average over the estimated between-trial heterogeneity.

## Overall impact

In order to directly quantify the expected impact of thrombectomy, we used parameter estimates from the statistical model to simulate actual patient-level outcomes. We did this for a hypothetical population of 200 total individuals, in which half are randomized to the control arm (best medical management) and half are randomized to the treatment arm (best medical management plus mechanial thrombectomy).

```{r}
#| echo: false

gq1 <- readRDS(here("fits", "gq1.RDS"))

df <- gq1$draws("rd_pred[1]")
df1_pos <- format(length(df[df >=1])/length(df)*100, digits = 2)
df1_plus <- format(length(df[df >= 5])/length(df)*100, digits = 2)
df1_plusplus <- format(length(df[df >= 10])/length(df)*100, digits = 2)
df1_plusplusplus <- format(length(df[df >= 20])/length(df)*100, digits = 2)

df <- gq1$draws("rd_pred[2]")
df2_pos <- format(length(df[df >=1])/length(df)*100, digits = 2)
df2_plus <- format(length(df[df >= 5])/length(df)*100, digits = 2)
df2_plusplus <- format(length(df[df >= 10])/length(df)*100, digits = 2)
df2_plusplusplus <- format(length(df[df >= 20])/length(df)*100, digits = 2)

df <- gq1$draws("rd_pred[3]")
df3_pos <- format(length(df[df >=1])/length(df)*100, digits = 2)
df3_plus <- format(length(df[df >= 5])/length(df)*100, digits = 2)
df3_plusplus <- format(length(df[df >= 10])/length(df)*100, digits = 2)
df3_plusplusplus <- format(length(df[df >= 20])/length(df)*100, digits = 2)

df <- gq1$draws("rd_pred[4]")
df4_pos <- format(length(df[df >=1])/length(df)*100, digits = 2)
df4_plus <- format(length(df[df >= 5])/length(df)*100, digits = 2)
df4_plusplus <- format(length(df[df >= 10])/length(df)*100, digits = 2)
df4_plusplusplus <- format(length(df[df >= 20])/length(df)*100, digits = 2)

```

Using this approach, we find that the conditional probability of any benefit (defined simply as more functionally independent patients in the treatment arm than the control arm) in a new trial of large core stroke thrombectomy is `r df1_pos`%, compared to `r df2_pos`% for small core, `r df3_pos`% with late window, and `r df4_pos`% with basilar occlusion.

The conditional probability of at least a moderate benefit (defined as a number needed to treat of 20 or fewer patients) is `r df1_plus`% for large, compared to `r df2_plus`% for small, `r df3_plus`% for late window, and `r df4_plus`% for basilar.

The conditional probability of at least a substantial benefit (defined as a number needed to treat of 10 or fewer patients) is `r df1_plusplus`% for large core, compared to `r df2_plusplus`% for small, `r df3_plusplus`% for late window, and `r df4_plusplus`% for basilar.

The conditional probability of at least a remarkable benefit (defined as a number needed to treat of 5 or fewer patients) is `r df1_plusplusplus`% for large core, compared to `r df2_plusplusplus`% for small, `r df3_plusplusplus`% for late window, and `r df4_plusplusplus`% for basilar.

# Discussion

## Interpretation of our results

Experts recommend that treatment effects should be communicated to patients in terms of the clinician's best estimate of how the treatment is expected to change the probability of the patient experiencing the outcome that most matters to them.

In the case of ischemic stroke, this outcome is typically functional independence. Thus, when engaging patients and families in a discussion over the risks and benefits of mechanical thrombectomy, the key questions to address are, first, what is best estimate of the patients chance of functional independence without treatment, and two, what is the best estimate of how these chances change, in absolute terms, with treatment. This is the minimum amount of information a patient needs to make an informed decision.

Although there are numerous meta-analyses of randomized trial data from stroke thrombectomy, none have utilized this patient-centered, common language approach to data analysis. In this paper, we aimed to adapt the traditional statistical model underlying most meta-analyses in order to analyze data from all 22 trials of stroke thrombectomy from this patient-centered perspective.

When considering the predicted impact in a hypothetical new trial, we found a greater than 95% probability of a predictive positive impact across all types of stroke, but that there was substantial and clinically relevant divergence across stroke types in terms of projected absolute impact on patient-level outcomes. We performed number-needed-to-treat based simulation studies to portray this phenomenon in a way that can be easily applied to real-world risk communication.

We conclude that while thrombectomy is expected to have a substantial positive effect on the probability of functional independence in a new trial, this impact varies by stroke type, and the absolute probability of functional independence is still low, especially for large core stroke.

## Comparison to other work

Meta-analysis has traditionally been used to aggregate evidence from multiple clinical trials, carried out in similar but not identical contexts, in order to increase the precision of an estimate for an underlying but not-directly-observable quantity known as the average treatment effect.

This approach is useful in contexts where there are multiple small studies with perhaps diverging results, or when the relevant clinical question is whether the observed results from a portfolio of trials reflect a real underlying pattern at all, as opposed to random variation.

In the case of thrombectomy, however, we have arrived at a point where the relevant questions no longer have to do with whether we can confidently reject a null hypothesis of "no effect," as the implausibility of such an hypothesis seems clear enough even before the application of advanced statistics. Instead, what we would like to know is what the results of the clinical trials imply for future patients, who by definition are treated outside of these trials. This requires a reorientation from a focus on using statistical tools to accurately describe what happened in the past (the average treatment effect) towards an approach where we consider what the data implies about the range of plausible outcomes for future patients.

# Limitations

Randomized trials as a guide to real-world outcomes. Simplified model. Lack of patient-level data. No systematic review.

# Conclusions

In this paper, we aimed to show how an extension of the traditional meta-analytic framework using techniques from Bayesian data analysis can be used to derive rigorous yet easily interpretable conclusions about what the current landscape of stroke thrombectomy trials imply for real-world patient care scenarios. Under this analysis, thrombectomy is expected to have a substantial positive effect on the probability of functional independence in a new trial, but this impact varies by stroke type, and the absolute probability of functional independence is still low, especially for large core stroke.
